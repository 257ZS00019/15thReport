<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>インベーダー風シューティング</title>
<style>
  body {
    margin: 0;
    background: #000;
    color: #0f0;
    font-family: monospace;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
  }

  h1 { margin: 10px; }

  canvas {
    border: 2px solid #0f0;
    background: #000;
  }
</style>
</head>
<body>

<h1>SPACE INVADER</h1>
<canvas id="game" width="600" height="600"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// =========================
// サウンド（WebAudio）
// =========================
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function beep(freq, duration, type="square") {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = type;
  osc.frequency.value = freq;
  gain.gain.value = 0.1;
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + duration);
}

// =========================
// プレイヤー
// =========================
const player = {
  x: canvas.width/2 - 20,
  y: canvas.height - 60,
  width: 40,
  height: 20,
  speed: 6,
  alive: true
};

// =========================
// 入力
// =========================
const keys = {};
document.addEventListener("keydown", e => {
  keys[e.code] = true;
  audioCtx.resume();
});
document.addEventListener("keyup", e => keys[e.code] = false);

// =========================
// 弾
// =========================
const bullets = [];
const enemyBullets = [];

// =========================
// ステージ
// =========================
let stage = 1;
let score = 0;
let gameOver = false;
let boss = null;

let enemies = [];
let enemyDirection = 1;
let enemySpeed = 1;

function spawnEnemies() {
  enemies = [];
  const rows = 4 + stage;
  const cols = 6;
  for (let r=0; r<rows; r++) {
    for (let c=0; c<cols; c++) {
      enemies.push({
        x: 80 + c*70,
        y: 40 + r*50,
        width: 30,
        height: 30,
        alive: true
      });
    }
  }
}

function spawnBoss() {
  boss = {
    x: canvas.width/2 - 80,
    y: 80,
    width: 160,
    height: 60,
    hp: 20 + stage*10,
    dir: 1
  };
}

spawnEnemies();

// =========================
// 発射
// =========================
let lastShot = 0;
function shootPlayer(time) {
  if (!keys["Space"]) return;
  if (time - lastShot > 250) {
    bullets.push({x:player.x+player.width/2-2,y:player.y});
    beep(800,0.05);
    lastShot = time;
  }
}

function enemyShootRandom() {
  if (Math.random() < 0.02 + stage*0.005) {
    const shooters = enemies.filter(e=>e.alive);
    if (shooters.length===0) return;
    const e = shooters[Math.floor(Math.random()*shooters.length)];
    enemyBullets.push({x:e.x+15,y:e.y+30});
  }
}

function bossShoot() {
  if (!boss) return;
  if (Math.random() < 0.05) {
    enemyBullets.push({x:boss.x+boss.width/2,y:boss.y+boss.height});
  }
}

// =========================
// 衝突
// =========================
function hit(ax,ay,aw,ah,bx,by,bw,bh){
  return ax<bx+bw && ax+aw>bx && ay<by+bh && ay+ah>by;
}

function handleCollisions(){
  bullets.forEach((b,bi)=>{
    enemies.forEach(e=>{
      if(e.alive && hit(b.x,b.y,4,10,e.x,e.y,e.width,e.height)){
        e.alive=false;
        bullets.splice(bi,1);
        score+=100;
        beep(200,0.08);
      }
    });

    if(boss && hit(b.x,b.y,4,10,boss.x,boss.y,boss.width,boss.height)){
      boss.hp--;
      bullets.splice(bi,1);
      beep(120,0.05);
      if(boss.hp<=0){
        boss=null;
        score+=1000;
        stage++;
        enemySpeed+=0.5;
        spawnEnemies();
        beep(600,0.3);
      }
    }
  });

  enemyBullets.forEach((b,bi)=>{
    if(hit(b.x,b.y,4,10,player.x,player.y,player.width,player.height)){
      gameOver=true;
      beep(60,0.5);
    }
  });
}

// =========================
// 更新
// =========================
function updatePlayer(){
  if(keys.ArrowLeft) player.x-=player.speed;
  if(keys.ArrowRight) player.x+=player.speed;
  player.x=Math.max(0,Math.min(canvas.width-player.width,player.x));
}

function updateBullets(){
  bullets.forEach(b=>b.y-=8);
  enemyBullets.forEach(b=>b.y+=4+stage);

  for(let i=bullets.length-1;i>=0;i--) if(bullets[i].y<0) bullets.splice(i,1);
  for(let i=enemyBullets.length-1;i>=0;i--) if(enemyBullets[i].y>canvas.height) enemyBullets.splice(i,1);
}

function updateEnemies(){
  if(boss){
    boss.x+=2*boss.dir;
    if(boss.x<0||boss.x+boss.width>canvas.width) boss.dir*=-1;
    bossShoot();
    return;
  }

  let edge=false;
  enemies.forEach(e=>{
    if(!e.alive) return;
    e.x+=enemySpeed*enemyDirection;
    if(e.x<0||e.x+e.width>canvas.width) edge=true;
    if(e.y+e.height>=player.y) gameOver=true;
  });

  if(edge){
    enemyDirection*=-1;
    enemies.forEach(e=>e.y+=20);
  }

  enemyShootRandom();

  if(enemies.every(e=>!e.alive) && !boss){
    spawnBoss();
  }
}

// =========================
// 描画
// =========================
function drawPlayer(){
  ctx.fillStyle="#0f0";
  ctx.fillRect(player.x,player.y,player.width,player.height);
}

function drawBullets(){
  ctx.fillStyle="#fff";
  bullets.forEach(b=>ctx.fillRect(b.x,b.y,4,10));

  ctx.fillStyle="#ff0";
  enemyBullets.forEach(b=>ctx.fillRect(b.x,b.y,4,10));
}

function drawEnemies(){
  ctx.fillStyle="#f00";
  enemies.forEach(e=>{if(e.alive)ctx.fillRect(e.x,e.y,e.width,e.height);});
}

function drawBoss(){
  if(!boss) return;
  ctx.fillStyle="#f0f";
  ctx.fillRect(boss.x,boss.y,boss.width,boss.height);

  ctx.fillStyle="#fff";
  ctx.fillText("BOSS HP: "+boss.hp,boss.x,boss.y-10);
}

function drawUI(){
  ctx.fillStyle="#0f0";
  ctx.font="16px monospace";
  ctx.fillText("SCORE: "+score,10,20);
  ctx.fillText("STAGE: "+stage,10,40);
}

function drawGameOver(){
  ctx.fillStyle="#0f0";
  ctx.font="40px monospace";
  ctx.textAlign="center";
  ctx.fillText("GAME OVER",canvas.width/2,canvas.height/2);
}

// =========================
// ループ
// =========================
function gameLoop(time){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(!gameOver){
    updatePlayer();
    shootPlayer(time);
    updateBullets();
    updateEnemies();
    handleCollisions();
  }

  drawPlayer();
  drawBullets();
  drawEnemies();
  drawBoss();
  drawUI();

  if(gameOver) drawGameOver();

  requestAnimationFrame(gameLoop);
}

requestAnimationFrame(gameLoop);
</script>

</body>
</html>